<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v6.js"></script>
    <style>
        #my_dataviz {
            background-color: lightgrey;
        }

        #textinput {
            width: 80%;
        }

        .ent1:before {
            background-color: #df3312
        }

        .ent2:before {
            background-color: #1e8900
        }

        .ent3:before {
            background-color: #dd6b10
        }

        .ent4:before {
            background-color: #0073bb
        }

        .ent5:before {
            background-color: #ce6dbd
        }

        .ent6:before {
            background-color: #756bb1
        }
    </style>
</head>

<body>
    <textarea id="textinput"
        rows="5">INFO E. TMP: 13. WIND: 100/15 XW MAX 12 KTS RWY 16. CLD: FEW020. EXP INSTR APCH. RWY 07 FOR ARRS, RWYS 16L&R FOR DEPS. ACFT WITH GREATER THAN 36M WINGSPAN EXPECT INTERSECTION GOLF FOR DEPARTURE RWY 16R. WET. VIS: 10KM IN RAIN. QNH: 1026.</textarea>
    <button id="randomSample">Random Sample</button>
    <div id="my_dataviz"></div>
    <pre id="dbg"></pre>
    <script>
        const ICAO_ALPHABET = {
            "A": "Alpha",
            "B": "Bravo",
            "C": "Charlie",
            "D": "Delta",
            "E": "Echo",
            "F": "Foxtrot",
            "G": "Golf",
            "H": "Hotel",
            "I": "India",
            "J": "Juliett",
            "K": "Kilo",
            "L": "Lima",
            "M": "Mike",
            "N": "November",
            "O": "Oscar",
            "P": "Papa",
            "Q": "Quebec",
            "R": "Romeo",
            "S": "Sierra",
            "T": "Tango",
            "U": "Uniform",
            "V": "Victor",
            "W": "Whiskey",
            "X": "X-ray",
            "Y": "Yankee",
            "Z": "Zulu"
        };

        function dbg(msg) {
            document.getElementById('dbg').innerHTML += JSON.stringify(msg) + "\n";
        }

        function getTermMeaning(word, sentence, termsdata) {
            word = word.replace(/[^a-zA-Z0-9]/g, "");

            if (word.length == 1 && sentence.startsWith("INFO")) {
                return [word.charCodeAt(0), ICAO_ALPHABET[word]];
            }

            for (var i=0; i<termsdata.length; i++) {
                if (termsdata[i]['Acronym'].toUpperCase() == word.toUpperCase()) {
                    return [i, termsdata[i]['Meaning']];
                }
            };

            return null;
        }

        const margin = { top: 50, right: 30, bottom: 50, left: 30 },
            width = document.width - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        const svg = d3.select("#my_dataviz")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")")

        d3.json("./terms.json").then(function (termsdata) {
            var alltext = document.getElementById("textinput").value.trim();

            var sentences = alltext.split(".");

            var lastsentence = {
                y: 0
            };

            for (var sentence of sentences) {
                var trimmed = sentence.trim();

                if (trimmed == "") {
                    continue;
                }

                var words = trimmed.split(" ");

                var lastword = {
                    x: 0,
                    width: 0
                };

                const COLORS = [
                    "#df3312",
                    "#1e8900",
                    "#dd6b10",
                    "#0073bb",
                    "#ce6dbd",
                    "#756bb1"
                ];

                for (var word of words) {
                    var lastword = svg.append('text')
                        .attr('x', d => lastword.width + lastword.x + 4)
                        .attr('y', d => lastsentence.y)
                        .attr('stroke', 'black')
                        .style("font-size", 12)
                        .text(word)
                        .node().getBBox();

                    var termmeaning = getTermMeaning(word, trimmed, termsdata);
                    
                    if (termmeaning) {
                        svg.append('rect')
                            .attr('x', lastword.x)
                            .attr('y', lastword.y + lastword.height)
                            .attr('rx', 3)
                            .attr('ry', 3)
                            .attr('width', lastword.width)
                            .attr('height', 3)
                            .attr('fill', COLORS[termmeaning[0]%COLORS.length]);
                        
                        svg.append('circle')
                            .attr('cx', lastword.x + 2)
                            .attr('cy', lastword.y + lastword.height + 10)
                            .attr('r', 3)
                            .attr('fill', COLORS[termmeaning[0]%COLORS.length]);
                        
                        var expandedword = svg.append('text')
                            .attr('x', d => lastword.x + 6)
                            .attr('y', d => lastword.y + lastword.height + 12)
                            .attr('stroke', 'black')
                            .style("font-size", 8)
                            .text(termmeaning[1])
                            .node().getBBox();
                        
                        if (expandedword.width > lastword.width) {
                            lastword = expandedword;
                        }
                    }
                }

                svg.append('text')
                    .attr('x', d => lastword.width + lastword.x + 4)
                    .attr('y', d => lastsentence.y)
                    .attr('stroke', 'black')
                    .style("font-size", 12)
                    .text(".");

                lastsentence.y += 40;
            }
        });

        d3.json("./samples.json").then(function (sampledata) {
            document.getElementById('randomSample').click(() => {
                var sample = sampledata[Math.floor(Math.random()*sampledata.length)];
                dbg(sample);
                document.getElementById('textinput').value = sample['tweet'];
            });
        });
    </script>
</body>